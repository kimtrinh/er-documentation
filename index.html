<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KP SBC ER Toolkit</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080f1a;--surface:#0d1829;--surface2:#111f35;--surface3:#162540;
  --border:#1a2d48;--border2:#243d5c;
  --text:#e8f0fc;--text2:#8fa8c8;--text3:#4a6280;
  --blue:#3b82f6;--blue2:#1d4ed8;--blue3:#0d2038;
  --green:#22c55e;--green2:#15803d;--green3:#0d2d1f;
  --amber:#f59e0b;--red:#ef4444;--purple:#a78bfa;--cyan:#22d3ee;
  --mono:'JetBrains Mono',monospace;--sans:'DM Sans',system-ui,sans-serif;
}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh}

/* NAV - compact, links only */
.sitenav{background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.sitenav-inner{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;align-items:center;gap:8px;height:46px}
.nav-logo{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--blue);white-space:nowrap;flex-shrink:0;text-decoration:none;margin-right:6px}
.nav-logo span{color:var(--text3)}
.nav-links{display:flex;gap:1px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.nav-links::-webkit-scrollbar{display:none}
.nav-link{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:600;color:var(--text2);text-decoration:none;white-space:nowrap;transition:all .15s}
.nav-link:hover{background:var(--surface2);color:var(--text)}
.nav-link.active{background:var(--blue2);color:#fff}

/* SEARCH HERO - full width */
.search-hero{background:linear-gradient(170deg,#0f1e38 0%,var(--bg) 100%);border-bottom:1px solid var(--border);padding:24px 0 20px}
.search-hero-inner{max-width:100%;padding:0 24px}
.search-label{font-size:15px;font-weight:800;color:var(--text);margin-bottom:2px}
.search-sublabel{font-size:12px;color:var(--text3);margin-bottom:14px}

/* THE BIG SEARCH */
.search-wrap{position:relative;width:100%}
.search-input{
  width:100%;
  padding:15px 120px 15px 52px;
  background:var(--surface);
  border:1.5px solid var(--border2);
  border-radius:12px;
  color:var(--text);
  font-size:16px;
  font-family:var(--sans);
  outline:none;
  transition:border-color .2s,box-shadow .2s;
  -webkit-appearance:none;
}
.search-input:focus{border-color:var(--blue);box-shadow:0 0 0 4px rgba(59,130,246,.15)}
.search-input::placeholder{color:var(--text3)}
.search-icon{position:absolute;left:17px;top:50%;transform:translateY(-50%);font-size:19px;pointer-events:none}
.search-shortcut{position:absolute;right:15px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--text3);font-family:var(--mono);background:var(--surface2);border:1px solid var(--border);padding:3px 8px;border-radius:5px;pointer-events:none;white-space:nowrap}

/* DROPDOWN */
.search-dropdown{position:absolute;top:calc(100% + 8px);left:0;right:0;background:var(--surface);border:1px solid var(--border2);border-radius:12px;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.75);z-index:500;display:none;max-height:72vh;overflow-y:auto}
.search-dropdown.open{display:block}
.sdrop-group{padding:7px 14px 3px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);border-top:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:1}
.sdrop-group:first-child{border-top:none}
.sdrop-row{display:flex;align-items:center;gap:12px;padding:9px 14px;text-decoration:none;transition:background .1s;cursor:pointer}
.sdrop-row:hover,.sdrop-row.hi{background:var(--surface2)}
.sdrop-row:focus-visible{outline:2px solid #60a5fa;outline-offset:-2px}
.sdrop-ico{font-size:15px;width:22px;text-align:center;flex-shrink:0}
.sdrop-body{flex:1;min-width:0}
.sdrop-title{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sdrop-sub{font-size:11px;color:var(--text3);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sdrop-tag{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:700;white-space:nowrap;flex-shrink:0;border:1px solid transparent}
.t-phrase{background:var(--blue3);color:#38bdf8;border-color:#0369a1}
.t-calc{background:var(--green3);color:#4ade80;border-color:var(--green2)}
.t-drug{background:#2d1f0d;color:#fb923c;border-color:#c2410c}
.t-phone{background:#1f1a0d;color:#facc15;border-color:#a16207}
.t-algo{background:#0d2d2d;color:#22d3ee;border-color:#0e7490}
.t-neuro{background:#1f0d2d;color:#e879f9;border-color:#a21caf}
.sdrop-empty{padding:22px 14px;text-align:center;font-size:13px;color:var(--text3)}
.sdrop-footer{padding:5px 14px 8px;font-size:11px;color:var(--text3);border-top:1px solid var(--border)}

/* FILTER CHIPS */
.chips{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.chip{padding:5px 13px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text3);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(--sans)}
.chip:hover{border-color:var(--border2);color:var(--text2);background:var(--surface2)}
.chip.on{border-color:var(--blue);background:var(--blue3);color:#38bdf8}

/* STATS */
.stats-row{display:flex;gap:22px;margin-top:16px}
.stn{font-size:18px;font-weight:800;color:var(--blue);font-family:var(--mono);line-height:1}
.stl{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

/* MAIN */
main{max-width:1100px;margin:0 auto;padding:22px 24px 80px}
.sec-head{display:flex;align-items:center;gap:10px;margin:22px 0 11px}
.sec-head h2{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);white-space:nowrap}
.sec-head::after{content:'';flex:1;height:1px;background:var(--border)}

/* TOOL GRID */
.tool-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));gap:8px}
.tc{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px;transition:all .15s;text-decoration:none;display:flex;flex-direction:column;gap:5px}
.tc:hover{border-color:var(--border2);background:var(--surface2);transform:translateY(-1px)}
.tc.hi-blue{border-color:rgba(59,130,246,.35)}
.tc.hi-purple{border-color:rgba(126,34,206,.35);position:relative}
.tc.hi-purple::after{content:'NEW';position:absolute;top:8px;right:8px;background:#7e22ce;color:#fff;font-size:9px;font-weight:800;padding:1px 5px;border-radius:20px}
.tc-ico{font-size:21px}
.tc-name{font-size:13px;font-weight:700;color:var(--text)}
.tc-desc{font-size:11px;color:var(--text3);line-height:1.4;flex:1}
.tc-meta{display:flex;align-items:center;margin-top:2px}
.tc-count{font-size:10px;color:var(--text3);font-family:var(--mono)}
.tc-arr{margin-left:auto;color:var(--border2);font-size:13px;transition:color .15s}
.tc:hover .tc-arr{color:var(--blue)}

/* TWO COL PANELS */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:11px}
@media(max-width:640px){.two-col{grid-template-columns:1fr}}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.panel-hd{padding:9px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px}
.prow{display:flex;align-items:center;gap:10px;padding:8px 14px;transition:background .1s;text-decoration:none}
.prow:hover{background:var(--surface2)}
.prow-body{flex:1;min-width:0}
.prow-title{font-size:13px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prow-sub{font-size:11px;color:var(--text3)}
.prow-tag{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:600;flex-shrink:0;white-space:nowrap}
.pt-blue{background:var(--blue3);color:#38bdf8}
.pt-green{background:var(--green3);color:#4ade80}
.pt-orange{background:#2d1f0d;color:#fb923c}
.pt-purple{background:#1f0d2d;color:#e879f9}

/* QUICK DIAL */
.dial-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.dial-sec-label{display:block;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);padding:9px 14px 5px;border-top:1px solid var(--border)}
.dial-sec:first-child .dial-sec-label{border-top:none}
.dial-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(148px,1fr));gap:7px;padding:0 12px 11px}
.dc{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;text-decoration:none;display:block;transition:all .15s}
.dc:hover{border-color:var(--border2);background:var(--surface2)}
.dc.omc{border-color:rgba(59,130,246,.28);background:rgba(13,32,56,.55)}
.dc.fmc{border-color:rgba(34,197,94,.22);background:rgba(13,45,31,.5)}
.dc.ext{border-color:rgba(245,158,11,.22);background:rgba(45,31,13,.45)}
.dc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:3px;line-height:1.3}
.dc-num{font-size:14px;font-weight:800;color:var(--text);font-family:var(--mono);line-height:1}
.dc-note{font-size:9px;color:var(--text3);margin-top:2px;line-height:1.3}

/* MOBILE */
@media(max-width:640px){
  .search-hero-inner,.main{padding-left:16px;padding-right:16px}
  .search-shortcut{display:none}
  .stats-row{display:none}
  .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;padding:5px 0 calc(5px + env(safe-area-inset-bottom));z-index:100}
  .mob-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;padding:2px 0;font-size:9px;font-weight:700;color:var(--text3);text-decoration:none;text-transform:uppercase}
  .mob-item.active{color:var(--blue)}
  .mob-icon{font-size:19px}
  main{padding-bottom:80px}
}
@media(min-width:641px){.mobile-nav{display:none}}
</style>
</head>
<body>

<!-- NAV -->
<nav class="sitenav">
  <div class="sitenav-inner">
    <a class="nav-logo" href="index.html">‚ö° KP<span>/</span>ER</a>
    <div class="nav-links">
      <a class="nav-link active" href="index.html">üè† Home</a>
      <a class="nav-link" href="dotphrase.html">üìã Phrases</a>
      <a class="nav-link" href="calculators.html">üßÆ Calcs</a>
      <a class="nav-link" href="vasopressors.html">üíä Vasopressors</a>
      <a class="nav-link" href="rsi.html">ü´Å RSI</a>
      <a class="nav-link" href="algorithms.html">üîÄ Algorithms</a>
      <a class="nav-link" href="neurohub.html">üß† Neuro Hub</a>
      <a class="nav-link" href="pedsfever.html">üå°Ô∏è Peds Fever</a>
      <a class="nav-link" href="service-agreements.html">üìë Service Agreements</a>
      <a class="nav-link" href="ed-phone-directory.html">üìû Directory</a>
      <a class="nav-link" href="links.html">üîó Links</a>
      <a class="nav-link" href="roadmap.html">üó∫Ô∏è Roadmap</a>
    </div>
  </div>
</nav>

<!-- FULL-WIDTH SEARCH HERO -->
<div class="search-hero">
  <div class="search-hero-inner">
    <div class="search-label">KP SBC Emergency Medicine</div>
    <div class="search-sublabel">OMC ¬∑ FMC ‚Äî search dotphrases, calculators, drugs, algorithms, and phone numbers</div>
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="search-input" id="si" type="text"
        placeholder="Search everything ‚Äî e.g. PE, ketamine, ortho, HEART score, aortic dissection, 47333, ETAP..."
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
        role="combobox" aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false"
        aria-controls="sd" aria-label="Search toolkit and phone directory"
        oninput="doSearch(this.value)" onkeydown="searchKey(event)"/>
      <span class="search-shortcut">‚åòK to focus</span>
      <div class="search-dropdown" id="sd" role="listbox" aria-label="Search results"></div>
    </div>
    <div class="chips">
      <button class="chip on" onclick="setFilter('all',this)">All</button>
      <button class="chip" onclick="setFilter('phrase',this)">üìã Dotphrases</button>
      <button class="chip" onclick="setFilter('calc',this)">üßÆ Calculators</button>
      <button class="chip" onclick="setFilter('drug',this)">üíä Drugs</button>
      <button class="chip" onclick="setFilter('algo',this)">üîÄ Algorithms</button>
      <button class="chip" onclick="setFilter('neuro',this)">üß† Neuro Hub</button>
      <button class="chip" onclick="setFilter('phone',this)">üìû Phones</button>
    </div>
    <div class="stats-row">
      <div><div class="stn" id="stat-phrases">127</div><div class="stl">Dotphrases</div></div>
      <div><div class="stn" id="stat-calcs">13</div><div class="stl">Calculators</div></div>
      <div><div class="stn" id="stat-algos">7</div><div class="stl">Algorithms</div></div>
      <div><div class="stn" id="stat-contacts">132</div><div class="stl">Contacts</div></div>
    </div>
  </div>
</div>

<main>
  <!-- TOOLS -->
  <div class="sec-head"><h2>Clinical Tools</h2></div>
  <div class="tool-grid" style="margin-bottom:22px">
    <a class="tc hi-blue" href="dotphrase.html"><div class="tc-ico">üìã</div><div class="tc-name">Dotphrases</div><div class="tc-desc">Rule-out templates across 20 categories</div><div class="tc-meta"><span class="tc-count">120 phrases</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="calculators.html"><div class="tc-ico">üßÆ</div><div class="tc-name">Calculators</div><div class="tc-desc">HEART, Wells PE/DVT, PERC, PECARN, LRINEC</div><div class="tc-meta"><span class="tc-count">12 calcs</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="vasopressors.html"><div class="tc-ico">üíä</div><div class="tc-name">Vasopressors</div><div class="tc-desc">Weight-based drip dosing + push-dose</div><div class="tc-meta"><span class="tc-count">8 agents</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="rsi.html"><div class="tc-ico">ü´Å</div><div class="tc-name">RSI</div><div class="tc-desc">Induction + paralytic dosing, airway flags</div><div class="tc-meta"><span class="tc-count">Weight-based</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="algorithms.html"><div class="tc-ico">üîÄ</div><div class="tc-name">Algorithms</div><div class="tc-desc">KP SBC ED Practice Guideline flowcharts</div><div class="tc-meta"><span class="tc-count">7 algorithms</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="neurohub.html"><div class="tc-ico">üß†</div><div class="tc-name">Neuro Hub</div><div class="tc-desc">ICH, tPA criteria, reversal, stroke triage</div><div class="tc-meta"><span class="tc-count">ICH ¬∑ tPA ¬∑ Reversal</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="pedsfever.html"><div class="tc-ico">üå°Ô∏è</div><div class="tc-name">Peds Fever</div><div class="tc-desc">CA FIRST age-stratified workup protocol</div><div class="tc-meta"><span class="tc-count">Age-stratified</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc hi-purple" href="service-agreements.html"><div class="tc-ico">ü§ù</div><div class="tc-name">Service Agreements</div><div class="tc-desc">Consult criteria &amp; escalation by specialty</div><div class="tc-meta"><span class="tc-count" style="color:var(--purple)">Add yours</span><span class="tc-arr">‚Üí</span></div></a>
    <a class="tc" href="ed-phone-directory.html"><div class="tc-ico">üìû</div><div class="tc-name">Phone Directory</div><div class="tc-desc">OMC &amp; FMC ‚Äî all extensions, pagers, lines</div><div class="tc-meta"><span class="tc-count">200+ contacts</span><span class="tc-arr">‚Üí</span></div></a>
  </div>

  <!-- QUICK ACCESS + AGREEMENTS -->
  <div class="two-col" style="margin-bottom:22px">
    <div class="panel">
      <div class="panel-hd">‚ö° Quick Access</div>
      <a class="prow" href="dotphrase.html"><div class="prow-body"><div class="prow-title">PE Rule-Out <span style="font-family:var(--mono);font-size:11px;color:var(--text3)">.nope</span></div><div class="prow-sub">PERC ¬∑ Wells ¬∑ low probability</div></div><span class="prow-tag pt-blue">Chest</span></a>
      <a class="prow" href="dotphrase.html"><div class="prow-body"><div class="prow-title">ACS Rule-Out <span style="font-family:var(--mono);font-size:11px;color:var(--text3)">.noacs</span></div><div class="prow-sub">HEART score ¬∑ serial troponins</div></div><span class="prow-tag pt-blue">Chest</span></a>
      <a class="prow" href="dotphrase.html"><div class="prow-body"><div class="prow-title">SAH Rule-Out <span style="font-family:var(--mono);font-size:11px;color:var(--text3)">.nosah</span></div><div class="prow-sub">Ottawa rule ¬∑ thunderclap headache</div></div><span class="prow-tag pt-blue">HA</span></a>
      <a class="prow" href="vasopressors.html"><div class="prow-body"><div class="prow-title">Norepinephrine</div><div class="prow-sub">0.01‚Äì3 mcg/kg/min ¬∑ septic shock first-line</div></div><span class="prow-tag pt-orange">Vasc</span></a>
      <a class="prow" href="calculators.html"><div class="prow-body"><div class="prow-title">HEART Score</div><div class="prow-sub">ACS chest pain risk stratification</div></div><span class="prow-tag pt-green">Calc</span></a>
      <a class="prow" href="neurohub.html"><div class="prow-body"><div class="prow-title">ICH Protocol</div><div class="prow-sub">BP targets ¬∑ reversal ¬∑ neurosurg criteria</div></div><span class="prow-tag pt-purple">Neuro</span></a>
    </div>
    <div class="panel">
      <div class="panel-hd">ü§ù Service Agreements</div>
      <a class="prow" href="service-agreements.html" style="display:flex;flex-direction:column;align-items:flex-start;padding:18px 14px;gap:8px">
        <div style="font-size:13px;color:var(--text2);line-height:1.6">No agreements yet. Document consult criteria, response times, and escalation paths by specialty.</div>
        <div style="font-size:12px;font-weight:700;color:var(--purple)">+ Add first agreement ‚Üí</div>
      </a>
    </div>
  </div>

  <!-- QUICK DIAL -->
  <div class="sec-head"><h2>Quick Dial</h2></div>
  <div class="dial-box">

    <div class="dial-sec">
      <span class="dial-sec-label">üîµ OMC ‚Äî Internal Medicine</span>
      <div class="dial-grid">
        <a class="dc omc" href="ed-phone-directory.html"><div class="dc-lbl">OMC Int. Med 7a‚Äì3:30p</div><div class="dc-num">Vocera</div><div class="dc-note">Extension</div></a>
        <a class="dc omc" href="ed-phone-directory.html"><div class="dc-lbl">OMC Int. Med 3:30p‚Äì7a</div><div class="dc-num">47333</div><div class="dc-note">Extension</div></a>
      </div>
    </div>

    <div class="dial-sec">
      <span class="dial-sec-label">üü¢ FMC ‚Äî Internal Medicine</span>
      <div class="dial-grid">
        <a class="dc fmc" href="ed-phone-directory.html"><div class="dc-lbl">FMC Int. Med 7a‚Äì7p</div><div class="dc-num">Vocera</div><div class="dc-note">Extension</div></a>
        <a class="dc fmc" href="ed-phone-directory.html"><div class="dc-lbl">FMC Int. Med 7p‚Äì7a</div><div class="dc-num">27028</div><div class="dc-note">Extension</div></a>
      </div>
    </div>

    <div class="dial-sec">
      <span class="dial-sec-label">üîµ OMC ‚Äî ED Lines</span>
      <div class="dial-grid">
        <a class="dc omc" href="ed-phone-directory.html"><div class="dc-lbl">OMC Charge Nurse</div><div class="dc-num">45860</div><div class="dc-note">CISCO wireless ¬∑ office 45832</div></a>
        <a class="dc omc" href="ed-phone-directory.html"><div class="dc-lbl">OMC Ambulance Triage</div><div class="dc-num">45861</div><div class="dc-note">Ambulance RN</div></a>
        <a class="dc omc" href="ed-phone-directory.html"><div class="dc-lbl">OMC Triage</div><div class="dc-num">49808</div><div class="dc-note">30-Second Triage</div></a>
      </div>
    </div>

    <div class="dial-sec">
      <span class="dial-sec-label">üü¢ FMC ‚Äî ED Lines</span>
      <div class="dial-grid">
        <a class="dc fmc" href="ed-phone-directory.html"><div class="dc-lbl">FMC Charge Nurse</div><div class="dc-num">27071</div><div class="dc-note">Beeper 1204</div></a>
        <a class="dc fmc" href="ed-phone-directory.html"><div class="dc-lbl">FMC Ambulance Triage</div><div class="dc-num">27018</div><div class="dc-note">Extension</div></a>
        <a class="dc fmc" href="ed-phone-directory.html"><div class="dc-lbl">FMC Triage</div><div class="dc-num">27008</div><div class="dc-note">Extension</div></a>
      </div>
    </div>

    <div class="dial-sec">
      <span class="dial-sec-label">üü° External / Transfer</span>
      <div class="dial-grid">
        <a class="dc ext" href="ed-phone-directory.html"><div class="dc-lbl">ETAP</div><div class="dc-num">(562) 658-3998</div><div class="dc-note">Emergency Transfer Auth.</div></a>
        <a class="dc ext" href="ed-phone-directory.html"><div class="dc-lbl">PTAC</div><div class="dc-num">(562) 658-3980</div><div class="dc-note">Transfer Authorization</div></a>
        <a class="dc ext" href="ed-phone-directory.html"><div class="dc-lbl">Poison Control</div><div class="dc-num">(800) 222-1222</div><div class="dc-note">24/7</div></a>
        <a class="dc ext" href="ed-phone-directory.html"><div class="dc-lbl">SART Nurse</div><div class="dc-num">(909) 427-9227</div><div class="dc-note">Sexual Assault Response</div></a>
      </div>
    </div>

  </div>
</main>

<div class="mobile-nav">
  <a class="mob-item active" href="index.html"><span class="mob-icon">üè†</span>Home</a>
  <a class="mob-item" href="dotphrase.html"><span class="mob-icon">üìã</span>Phrases</a>
  <a class="mob-item" href="calculators.html"><span class="mob-icon">üßÆ</span>Calcs</a>
  <a class="mob-item" href="vasopressors.html"><span class="mob-icon">üíä</span>Drugs</a>
  <a class="mob-item" href="ed-phone-directory.html"><span class="mob-icon">üìû</span>Directory</a>
</div>

<script src="search-index.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEARCH INDEX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Search index loaded from search-index.js
const getIDX = () => (window.getSearchIndex ? window.getSearchIndex() : SEARCH_INDEX);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEARCH LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilter = 'all';
let hiIdx = -1;

const GROUP_PRIORITY = [
  'Dotphrases','Calculators','Algorithms','Neuro Hub','Drugs',
  'OMC','FMC','External',
  'OMC Imaging Orders','FMC Imaging Orders',
  'OMC Key Staff','FMC Key Staff',
  'Reference'
];

function matchesActiveFilter(item) {
  if (activeFilter === 'all') return true;
  if (activeFilter === 'phone') return ['phone', 'imaging', 'staff'].includes(item.type);
  return item.type === activeFilter;
}

function getResultGroup(item) {
  if (item.type === 'phrase') return 'Dotphrases';
  if (item.type === 'calc') return 'Calculators';
  if (item.type === 'drug') return 'Drugs';
  if (item.type === 'phone') return item.g || 'Phone Directory';
  if (item.type === 'imaging') return item.g || 'Imaging Orders';
  if (item.type === 'staff') return item.g || 'Key Staff';
  if (item.type === 'algo') return 'Algorithms';
  if (item.type === 'neuro') return 'Neuro Hub';
  if (item.type === 'page') return item.g || 'Reference';
  return item.g || 'Other';
}

function getOrderedGroups(groups) {
  const names = Object.keys(groups);
  const rest = names.filter(n => !GROUP_PRIORITY.includes(n)).sort((a,b) => a.localeCompare(b));
  return GROUP_PRIORITY.filter(n => groups[n]).concat(rest);
}

function escapeHtml(value) {
  return String(value ?? '').replace(/[&<>"']/g, ch => (
    ch === '&' ? '&amp;' :
    ch === '<' ? '&lt;' :
    ch === '>' ? '&gt;' :
    ch === '"' ? '&quot;' : '&#39;'
  ));
}

function safeHref(href) {
  const trimmed = String(href || '').trim();
  return /^[A-Za-z0-9._/-]+\.html(?:#[A-Za-z0-9._:-]+)?$/.test(trimmed) ? trimmed : 'index.html';
}

function setSearchExpanded(open) {
  const input = document.getElementById('si');
  input.setAttribute('aria-expanded', open ? 'true' : 'false');
}

function clearSearchActiveDescendant() {
  document.getElementById('si').removeAttribute('aria-activedescendant');
}

function setSearchActiveDescendant(rows) {
  const input = document.getElementById('si');
  if (hiIdx >= 0 && rows[hiIdx] && rows[hiIdx].id) input.setAttribute('aria-activedescendant', rows[hiIdx].id);
  else clearSearchActiveDescendant();
}

function updateHomeStats() {
  const idx = getIDX();
  const counts = idx.reduce((acc, item) => {
    acc[item.type] = (acc[item.type] || 0) + 1;
    return acc;
  }, {});
  const phrases = counts.phrase || 0;
  const calcs = counts.calc || 0;
  const algos = counts.algo || 0;
  const contacts = (counts.phone || 0) + (counts.imaging || 0) + (counts.staff || 0);

  const setStat = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = String(value);
  };
  setStat('stat-phrases', phrases);
  setStat('stat-calcs', calcs);
  setStat('stat-algos', algos);
  setStat('stat-contacts', contacts);
}

function setFilter(f, el) {
  activeFilter = f;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  const q = document.getElementById('si').value;
  if (q.trim()) doSearch(q);
}

function doSearch(q) {
  const dd = document.getElementById('sd');
  q = q.trim();
  if (!q) {
    dd.classList.remove('open');
    hiIdx = -1;
    setSearchExpanded(false);
    clearSearchActiveDescendant();
    return;
  }
  const lo = q.toLowerCase();

  let results = getIDX().filter(item => {
    if (!matchesActiveFilter(item)) return false;
    return (
      item.t.toLowerCase().includes(lo) ||
      item.s.toLowerCase().includes(lo) ||
      item.g.toLowerCase().includes(lo)
    );
  });

  // Boost title-starts-with matches
  results.sort((a, b) => {
    const at = a.t.toLowerCase().startsWith(lo) ? 0 : 1;
    const bt = b.t.toLowerCase().startsWith(lo) ? 0 : 1;
    return at - bt;
  });

  const total = results.length;
  results = results.slice(0, 22);
  hiIdx = -1;

  if (!results.length) {
    dd.innerHTML = '<div class="sdrop-empty" role="status" aria-live="polite">No results ‚Äî try different keywords or clear the filter</div>';
    dd.classList.add('open');
    setSearchExpanded(true);
    clearSearchActiveDescendant();
    return;
  }

  const groups = {};
  results.forEach(r => {
    const g = getResultGroup(r);
    if (!groups[g]) groups[g] = [];
    groups[g].push(r);
  });

  let html = '';
  let rowIdx = 0;
  getOrderedGroups(groups).forEach(grp => {
    if (!groups[grp]) return;
    html += `<div class="sdrop-group">${escapeHtml(grp)}</div>`;
    groups[grp].forEach(item => {
      const rowId = `srow-${rowIdx++}`;
      html += `<a class="sdrop-row" id="${rowId}" role="option" aria-selected="false" href="${safeHref(item.u)}">
        <span class="sdrop-ico">${escapeHtml(item.i)}</span>
        <div class="sdrop-body">
          <div class="sdrop-title">${escapeHtml(item.t)}</div>
          <div class="sdrop-sub">${escapeHtml(item.s)}</div>
        </div>
        <span class="sdrop-tag ${escapeHtml(item.gc)}">${escapeHtml(item.g)}</span>
      </a>`;
    });
  });
  if (total > 22) {
    html += `<div class="sdrop-footer">Showing 22 of ${total} results ‚Äî refine your search</div>`;
  }
  dd.innerHTML = html;
  dd.classList.add('open');
  setSearchExpanded(true);
  clearSearchActiveDescendant();
}

function searchKey(e) {
  const dd = document.getElementById('sd');
  const rows = Array.from(dd.querySelectorAll('.sdrop-row'));
  if (e.key === 'ArrowDown') {
    hiIdx = Math.min(hiIdx + 1, rows.length - 1);
    rows.forEach((el, i) => {
      const active = i === hiIdx;
      el.classList.toggle('hi', active);
      el.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    setSearchActiveDescendant(rows);
    if (rows[hiIdx]) rows[hiIdx].scrollIntoView({block:'nearest'});
    e.preventDefault();
  } else if (e.key === 'ArrowUp') {
    hiIdx = Math.max(hiIdx - 1, 0);
    rows.forEach((el, i) => {
      const active = i === hiIdx;
      el.classList.toggle('hi', active);
      el.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    setSearchActiveDescendant(rows);
    e.preventDefault();
  } else if (e.key === 'Enter' && hiIdx >= 0 && rows[hiIdx]) {
    rows[hiIdx].click();
  } else if (e.key === 'Escape') {
    dd.classList.remove('open');
    setSearchExpanded(false);
    clearSearchActiveDescendant();
    document.getElementById('si').blur();
  }
}

// ‚åòK / Ctrl+K
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    const inp = document.getElementById('si');
    inp.focus(); inp.select();
  }
});

// click outside
document.addEventListener('click', e => {
  if (!e.target.closest('.search-wrap')) {
    document.getElementById('sd').classList.remove('open');
    setSearchExpanded(false);
    clearSearchActiveDescendant();
  }
});

document.getElementById('si').addEventListener('focus', () => {
  const q = document.getElementById('si').value.trim();
  if (q) doSearch(q);
});

window.addEventListener('kp-search-index-updated', () => {
  const q = document.getElementById('si').value.trim();
  if (q) doSearch(q);
});

updateHomeStats();
window.addEventListener('storage', e => {
  const keys = window.KP_ER_SEARCH
    ? [window.KP_ER_SEARCH.phoneIndexStorageKey, window.KP_ER_SEARCH.serviceAgreementsStorageKey]
    : [];
  if (!keys.length || keys.includes(e.key)) {
    updateHomeStats();
    const q = document.getElementById('si').value.trim();
    if (q) doSearch(q);
  }
});
</script>
</body>
</html>
